<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Car Following 101</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/dropdowns-enhancement.css" rel="stylesheet">
    <link href="css/demo.css" rel="stylesheet">

    <script src="js/jquery.min.js"></script>
    <script src="js/track.js"></script>
    <script src="js/model.js"></script>
    <script src="js/status.js"></script>
  </head>

    <div id="wrapper">
      <body>
        <h2><center>Car Following Model - How It Works</center></h2>
        <p>
          A demonstration of Wiedemann 99 <a target="_blank" href="https://en.wikipedia.org/wiki/Microscopic_traffic_flow_model">Car Following Model</a>, inspired by <a target="_blank" href="https://youtu.be/7wm-pZp_mi0">this</a> video.
          Created by <a target="_blank" href="https://www.linkedin.com/in/liugh">Guang-hui Liu</a>.
        </p>

        <hr>
      <div id="left_column">
        <h4>Simulation Controls</h4>
        <button type="button" class="btn btn-success" id="btn_start">Start</button>
        <button type="button" class="btn btn-success" id="btn_step">Step Forward</button>
        <button type="button" class="btn btn-warning" id="btn_pause">Pause</button>
        <button type="button" class="btn btn-danger" id="btn_reset">Reset</button>

        <h4>Vehicles and Drivers</h4>
        <h5>Number of Cars</h5>
        <div class="btn-group" id="form_cars_n" data-toggle="buttons" name='form_cars_n'>
          <label class="btn btn-default" id="btn_cars_n_4" value=4>
            <input type="radio"> 4
          </label>
          <label class="btn btn-default" id="btn_cars_n_8" value=8>
            <input type="radio"> 8
          </label>
          <label class="btn btn-default active" id="btn_cars_n_12" value=12>
            <input type="radio" checked> 12
          </label>
          <label class="btn btn-default" id="btn_cars_n_16" value=16>
            <input type="radio"> 16
          </label>
        </div>

        <div class="btn-group" id="form_cars_spacing" data-toggle="buttons" value='form_cars_spacing'>
          <label class="btn btn-default" id="btn_cars_spacing_even" value='even'>
            <input type="radio"> Evenly Spaced
          </label>
          <label class="btn btn-default active" id="btn_cars_spacing_close" value='close'>
            <input type="radio" checked> Closely Lined Up
          </label>
        </div>

        <h5>Driver Aggressiveness</h5>
        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default" id="btn_agg_high">
            <input type="radio"> Aggressive
          </label>
          <label class="btn btn-default active" id="btn_agg_mid">
            <input type="radio" checked> Average
          </label>
          <label class="btn btn-default" id="btn_agg_low">
            <input type="radio"> Conservative
          </label>
        </div>

        <!-- <h5>Driver Attention</h5>
        <div class="btn-group" data-toggle="buttons">
          <label class="btn btn-default" id="btn_att_high">
            <input type="radio"> Distracted
          </label>
          <label class="btn btn-default active" id="btn_att_mid">
            <input type="radio" checked> Average
          </label>
          <label class="btn btn-default" id="btn_att_low">
            <input type="radio"> Concentrated
          </label>
        </div> -->

        <center><canvas id="track" width="400" height="400"></canvas></center>
      </div>

      <div id="right_column">
        <h4>Vehicle Status</h4>
        <br>
        <div id="status_panel">
        </div>
      </div>

    </div>

    <script>
      function setStatusCanvas(n){
        var status_panel = document.getElementById("status_panel")

        //remove all existing canvas
        next_child = status_panel.firstChild;
        while(next_child) {
            status_panel.removeChild(next_child);
            next_child = status_panel.firstChild;
        }
        //create new canvas
        for (var i = 0; i < n; i++) {
          var new_canvas = document.createElement("canvas");
          new_canvas.id = "status" + (i+1).toString();
          new_canvas.width = STATUS_CANVAS_WIDTH;
          new_canvas.height = STATUS_CANVAS_HEIGHT;
          status_panel.appendChild(new_canvas);
        }
      }

      const DEFAULT_N_CAR = 12;
      const DEFAULT_SPACING = 16.5;

      $(document).ready(function(){
        var model = new w99(W99_DEFAULT);
        setStatusCanvas(DEFAULT_N_CAR);
        model.setCars(DEFAULT_N_CAR, DEFAULT_SPACING);

        $("#btn_start").click(function(){
          model.simRunContinous();
          $("label[id^='btn_cars_']").attr( "disabled", true);
        });
        $("#btn_step").click(function(){
          model.simRunStep();
          $("label[id^='btn_cars_']").attr( "disabled", true);
        });
        $("#btn_pause").click(function(){
          model.simPause();
        });
        $("#btn_reset").click(function(){
          model.simPause();
          model.resetCars();
          $("label[id^='btn_cars_']").attr( "disabled", false);
        });

        //use click event - not change - change doesn't fire every time
        $("label[id^='btn_cars_']").click(function(e){
          if (e.target.getAttribute("disabled") === "disabled") {return};
          var value = this.getAttribute('value');
          var n_car = model.cars.length; //default n_car
          var spacing = model.spacing; //default spacing
          if (value === "even") {
            spacing = undefined;
          } else if (value === "close") {
            spacing = DEFAULT_SPACING;
          } else {
            n_car = +this.getAttribute('value');
          }
          setStatusCanvas(n_car);
          model.setCars(n_car, spacing);
        });

        $("#btn_agg_high").click(function(){
          model.parameters.cc0 = W99_DEFAULT.cc0 * 0.85;
          model.parameters.cc1 = W99_DEFAULT.cc1 * 0.85;
        });
        $("#btn_agg_mid").click(function(){
          model.parameters.cc0 = W99_DEFAULT.cc0;
          model.parameters.cc1 = W99_DEFAULT.cc1;
        });
        $("#btn_agg_low").click(function(){
          model.parameters.cc0 = W99_DEFAULT.cc0 * 1.2;
          model.parameters.cc1 = W99_DEFAULT.cc1 * 1.2;
        });

        // $("#btn_att_high").click(function(){
        //   model.parameters.cc4 = W99_DEFAULT.cc4 * 2;
        //   model.parameters.cc5 = W99_DEFAULT.cc5 * 2;
        // });
        // $("#btn_att_mid").click(function(){
        //   model.parameters.cc4 = W99_DEFAULT.cc4;
        //   model.parameters.cc5 = W99_DEFAULT.cc5;
        // });
        // $("#btn_att_low").click(function(){
        //   model.parameters.cc4 = W99_DEFAULT.cc4 * 0.5;
        //   model.parameters.cc5 = W99_DEFAULT.cc5 * 0.5;
        // });

      });

    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/dropdowns-enhancement.js"></script>

  </body>
</html>
